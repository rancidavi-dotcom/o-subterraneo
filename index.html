<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O Subterr√¢neo - Menu</title>
    <link rel="stylesheet" href="css/menu.css">
</head>
<body>
    <!-- Canvas de Fundo Animado -->
    <canvas id="menu-bg-canvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;"></canvas>

    <!-- Elementos Decorativos -->
    <div class="decor" style="top: 10%; left: 5%;">üêú</div>
    <div class="decor" style="top: 80%; left: 15%;">üêú</div>
    <div class="decor" style="top: 20%; right: 10%;">üêú</div>
    <div class="decor" style="top: 70%; right: 20%;">üêú</div>

    <div id="main-menu" class="menu-screen">
        <div class="title-container">
            <img src="assets/sprites/logo.svg" alt="O Subterr√¢neo" style="width: 250px; margin-bottom: -20px; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5));">
            <h1>O SUBTERR√ÇNEO</h1>
            <div class="subtitle">O DESTINO DA RAINHA</div>
        </div>
        <nav>
            <button id="btn-continue" style="display: none; background: #228b22;" onclick="continueGame()">Continuar de onde parei</button>
            <button onclick="window.location.href='game.html?mode=new'">Jogar Solo</button>
            <button onclick="showMenu('multiplayer-menu')" style="background: #4a148c; border: 1px solid #9c27b0;">Multiplayer Online</button>
            <button onclick="document.getElementById('file-input').click()">Carregar mundo salvo</button>
            <input type="file" id="file-input" style="display: none;" onchange="handleFileSelect(this)">
            <button onclick="showSettingsMenu()">Op√ß√µes</button>
        </nav>
        <div id="player-nickname-display" style="margin-top: 20px; font-size: 1.2rem; color: #fff;">
            Ol√°, <span id="current-nickname"></span>!
        </div>
    </div>


    <div id="multiplayer-menu" class="menu-screen" style="display: none;">
        <h1>MULTIPLAYER</h1>
        <nav>
            <button id="btn-continue-multiplayer" style="display: none; background: #228b22;" onclick="lobbyContinueRoom()">Continuar lobby: <span id="multi-colony-name"></span></button>
            <button onclick="lobbyCreateRoom()" style="background: #2b532b;">Criar Nova Sala (Novo Mundo)</button>
            
            <div style="margin: 15px 0; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 1px solid #555;">
                <label style="color: #aaa; font-size: 0.8em; display: block; margin-bottom: 8px;">ENTRAR EM UMA SALA:</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="join-room-code-input" placeholder="C√ìDIGO" maxlength="5" style="width: 100px; background: #111; border: 1px solid #777; color: #fff; padding: 8px; border-radius: 4px; font-family: monospace; text-transform: uppercase; text-align: center;">
                    <button onclick="lobbyJoinDirect()" style="flex: 1; background: #4a148c; padding: 5px; min-width: auto; margin: 0; font-size: 0.9em;">ENTRAR</button>
                </div>
            </div>

            <button onclick="showMenu('main-menu')">Voltar</button>
        </nav>
    </div>

    <div id="lobby-screen" class="menu-screen" style="display: none;">
        <h1 id="lobby-title">SALA: -----</h1>
        <div id="lobby-players-container" style="background: rgba(0,0,0,0.5); padding: 20px; border-radius: 10px; margin: 20px auto; max-width: 400px; border: 1px solid #555;">
            <h3>Jogadores (max 4):</h3>
            <ul id="player-list" style="list-style: none; padding: 0; text-align: left;">
                <!-- Lista de jogadores aparecer√° aqui -->
            </ul>
        </div>
        <nav id="lobby-controls">
            <button id="btn-ready" onclick="lobbyToggleReady()" style="background: #daa520;">Estou Pronto</button>
            <button id="btn-start" onclick="lobbyStartGame()" style="display: none; background: #228b22;">INICIAR JOGO</button>
            <button onclick="lobbyLeave()" class="btn-danger">Sair da Sala</button>
        </nav>
    </div>

    <!-- Menu de Configura√ß√µes (Main Menu) -->
    <div id="settings-menu-main" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Configura√ß√µes</h2>
            
            <div style="margin: 20px 0; text-align: left; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 1px solid #444;">
                <label style="color: gold; font-size: 0.9em; display: block; margin-bottom: 8px;">URL do Servidor Multiplayer:</label>
                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                    <input type="text" id="server-url-settings" placeholder="Ex: ws://localhost:8888" style="flex: 1; min-width: 200px; background: #111; border: 1px solid #555; color: #0f0; padding: 8px; border-radius: 4px; font-family: monospace;">
                    <button onclick="saveServerURL()" style="background: #228b22; padding: 5px 15px; min-width: auto; margin: 0;">Salvar</button>
                    <button onclick="copyCurrentInstanceURL()" style="background: #444; padding: 5px 10px; min-width: auto; margin: 0; font-size: 0.8em;">Copiar Meu Endere√ßo</button>
                </div>
                <small id="current-instance-info" style="color: #0f0; margin-top: 8px; display: block; font-family: monospace; font-size: 0.85em;">Detectando porta local...</small>
                <small style="color: #777; margin-top: 5px; display: block;">Cole aqui o endere√ßo da janela que criou a sala.</small>
            </div>

            <nav class="settings-nav">
                <button onclick="deleteSaveDataMain()" class="btn-danger">Excluir Mundo Salvo</button>
                <button onclick="showMenu('main-menu')">Voltar</button>
            </nav>
        </div>
    </div>

    <script>
        // const { ipcRenderer } = require('electron'); // REMOVIDO PARA NAVEGADOR

        // Function to generate a random 5-character alphanumeric code
        function generateRandomCode(length) {
            let result = '';
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            const charactersLength = characters.length;
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return result;
        }

        let playerNickname = ''; // Global variable for the player's nickname
        let localServerPort = 8888; // Default fallback

        // Escuta porta din√¢mica se estiver no Electron
        if (window.process && window.process.type === 'renderer') {
            const { ipcRenderer } = require('electron');
            ipcRenderer.on('server-port', (event, port) => {
                console.log("Porta do servidor local recebida:", port);
                localServerPort = port;
            });
        }

        // Load nickname on startup
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Iniciando Menu...");
            
            const nickname = localStorage.getItem('playerNickname');
            // Verifica se o apelido √© realmente v√°lido
            if (nickname && nickname !== 'null' && nickname !== 'undefined' && nickname.trim() !== '') {
                playerNickname = nickname;
                document.getElementById('current-nickname').innerText = playerNickname;
                showMenu('main-menu');
            } else {
                console.log("Apelido inv√°lido ou ausente, abrindo modal...");
                showMenu('nickname-modal');
            }
            
            // Verificar save r√°pido
            const autoSave = localStorage.getItem('osubterraneo_save');
            if (autoSave) {
                document.getElementById('btn-continue').style.display = 'block';
            }

            // Atualiza a URL do servidor nas configura√ß√µes e mostra a porta atual
            const savedUrl = localStorage.getItem('osubterraneo_server_url');
            const serverInput = document.getElementById('server-url-settings');
            if (serverInput) serverInput.value = savedUrl || "";
            
            // Pequeno delay para o Electron enviar a porta
            setTimeout(() => {
                const infoMsg = document.getElementById('current-instance-info');
                if (infoMsg) infoMsg.innerText = `Este servidor local: ws://localhost:${localServerPort}`;
            }, 500);
        });

        function saveServerURL() {
            let url = document.getElementById('server-url-settings').value.trim();
            if (url) {
                localStorage.setItem('osubterraneo_server_url', url);
                alert("URL salva! Para voltar ao padr√£o (auto-detectar), limpe o campo e salve.");
            } else {
                localStorage.removeItem('osubterraneo_server_url');
                alert("URL limpa! O jogo agora vai auto-detectar o servidor local.");
            }
        }

        function savePlayerNickname() {
            const input = document.getElementById('player-nickname-input');
            const nickname = input.value.trim();

            if (nickname.length < 3) {
                alert("O apelido deve ter no m√≠nimo 3 caracteres.");
                return;
            }
            if (nickname.length > 15) {
                alert("O apelido deve ter no m√°ximo 15 caracteres.");
                return;
            }

            playerNickname = nickname;
            localStorage.setItem('playerNickname', playerNickname);
            document.getElementById('current-nickname').innerText = playerNickname;
            document.getElementById('nickname-modal').style.display = 'none';
            // Garante que o menu principal apare√ßa
            showMenu('main-menu');
        }

        function continueGame() {
            window.location.href = 'game.html?mode=continue';
        }

        // --- L√ìGICA DE LOBBY MULTIPLAYER ---
        let lobbyWs = null;
        let currentRoomCode = null;
        let isHost = false;
        let isContinuing = false; 
        const PLAYER_ID = Math.random().toString(36).substr(2, 9);

        // Adiciona um catcher global de erros para o navegador
        window.onerror = function(msg, url, line) {
            alert("Erro no Script: " + msg + "\nLinha: " + line);
            return false;
        };

        // Fun√ß√£o unificada para garantir conex√£o antes de enviar comando
        function connectLobby(callback) {
            console.log("connectLobby chamada...");
            if (!playerNickname) { 
                const nick = localStorage.getItem('playerNickname');
                if (nick) playerNickname = nick;
                else { alert("Defina um apelido primeiro!"); return; }
            }
            
            // Se j√° tem conex√£o aberta, usa ela
            if (lobbyWs && lobbyWs.readyState === WebSocket.OPEN) {
                console.log("Usando conex√£o existente.");
                callback(lobbyWs);
                return;
            }

            // Se est√° fechado ou n√£o existe, cria novo
            if (!lobbyWs || lobbyWs.readyState === WebSocket.CLOSED || lobbyWs.readyState === WebSocket.CLOSING) {
                let serverUrl = localStorage.getItem('osubterraneo_server_url');
                if (!serverUrl) {
                    const isLocal = window.location.hostname === 'localhost' || 
                                    window.location.hostname === '127.0.0.1' || 
                                    window.location.protocol === 'file:';
                    serverUrl = isLocal ? `ws://localhost:${localServerPort}` : "wss://o-subterraneo.onrender.com";
                }

                console.log("Iniciando conex√£o WebSocket:", serverUrl);
                try {
                    lobbyWs = new WebSocket(serverUrl);
                } catch (e) {
                    alert("Falha Cr√≠tica na URL: " + serverUrl + "\nErro: " + e.message);
                    return;
                }

                lobbyWs.onmessage = (event) => {
                    try {
                        const msg = JSON.parse(event.data);
                        console.log("Recebido:", msg.type);
                        handleLobbyMessage(msg);
                    } catch (e) { console.error("Erro JSON:", e); }
                };

                lobbyWs.onclose = (e) => {
                    console.log("WebSocket Fechado:", e.code);
                    if (document.getElementById('lobby-screen').style.display === 'flex') {
                        alert("A conex√£o com o servidor caiu.");
                        showMenu('main-menu');
                    }
                };

                lobbyWs.onerror = (err) => {
                    console.error("Erro WebSocket:", err);
                    alert("N√£o foi poss√≠vel conectar ao servidor. Verifique se ele est√° rodando.");
                };
            }

            // Aguarda abrir
            if (lobbyWs.readyState === WebSocket.CONNECTING) {
                console.log("Aguardando conex√£o abrir...");
                const onOpen = () => {
                    console.log("Conex√£o aberta com sucesso!");
                    lobbyWs.removeEventListener('open', onOpen);
                    callback(lobbyWs);
                };
                lobbyWs.addEventListener('open', onOpen);
            } else if (lobbyWs.readyState === WebSocket.OPEN) {
                callback(lobbyWs);
            }
        }

        function handleLobbyMessage(msg) {
            switch (msg.type) {
                case 'room_created':
                    currentRoomCode = msg.code;
                    isHost = true;
                    showLobby(msg.players);
                    break;
                case 'room_update':
                    showLobby(msg.players);
                    break;
                case 'game_started':
                    const mode = isContinuing ? 'continue_multi' : 'new';
                    window.location.href = `game.html?mode=${mode}&host=${isHost}&code=${currentRoomCode}`;
                    break;
                case 'error':
                    alert("Erro do Servidor: " + msg.message);
                    break;
                case 'host_disconnected':
                    alert("O Host encerrou a sala.");
                    showMenu('main-menu');
                    break;
            }
        }

        function showLobby(players) {
            showMenu('lobby-screen');
            document.getElementById('lobby-title').innerText = "SALA: " + currentRoomCode;
            const list = document.getElementById('player-list');
            list.innerHTML = '';
            
            let allReady = true;
            players.forEach(p => {
                const li = document.createElement('li');
                li.style.padding = '10px';
                li.style.borderBottom = '1px solid #333';
                li.style.color = p.ready ? '#90ee90' : '#ffb6c1';
                li.innerHTML = `
                    <span style="font-size: 1.2em;">${p.isHost ? 'üëë' : 'üêú'}</span> 
                    <strong>${p.name}</strong> 
                    <span style="float: right;">${p.ready ? '[PRONTO]' : '[ESPERANDO...]'}</span>
                `;
                list.appendChild(li);
                if (!p.ready) allReady = false;
            });

            if (isHost) {
                const btnStart = document.getElementById('btn-start');
                btnStart.style.display = 'block';
                btnStart.disabled = !allReady || players.length < 2;
                btnStart.style.opacity = btnStart.disabled ? "0.5" : "1";
            }
        }

        function lobbyCreateRoom() {
            console.log("Bot√£o Criar clicado");
            isContinuing = false;
            connectLobby((ws) => {
                console.log("Enviando create_room...");
                ws.send(JSON.stringify({
                    type: 'create_room', payload: { id: PLAYER_ID, name: playerNickname }
                }));
            });
        }

        function lobbyContinueRoom() {
            isContinuing = true;
            connectLobby((ws) => ws.send(JSON.stringify({
                type: 'create_room', payload: { id: PLAYER_ID, name: playerNickname }
            })));
        }

        function lobbyJoinDirect() {
            const input = document.getElementById('join-room-code-input');
            const code = input.value.trim().toUpperCase();
            
            if (!code || code.length < 5) {
                alert("Digite um c√≥digo de 5 caracteres!");
                return;
            }

            console.log("Bot√£o Entrar Direto clicado para sala:", code);
            isContinuing = false;
            connectLobby((ws) => {
                console.log("Enviando join_room para:", code);
                ws.send(JSON.stringify({
                    type: 'join_room', code: code, payload: { id: PLAYER_ID, name: playerNickname }
                }));
                currentRoomCode = code;
                isHost = false;
            });
        }

        function lobbyJoinPrompt() {
            console.log("Bot√£o Entrar clicado");
            const code = prompt("Digite o c√≥digo da sala:");
            if (!code) return;
            isContinuing = false;
            connectLobby((ws) => {
                console.log("Enviando join_room para:", code);
                ws.send(JSON.stringify({
                    type: 'join_room', code: code.toUpperCase(), payload: { id: PLAYER_ID, name: playerNickname }
                }));
                currentRoomCode = code.toUpperCase();
                isHost = false;
            });
        }

        function lobbyToggleReady() {
            if (lobbyWs) lobbyWs.send(JSON.stringify({ type: 'toggle_ready', code: currentRoomCode }));
        }

        function lobbyStartGame() {
            if (lobbyWs) lobbyWs.send(JSON.stringify({ type: 'start_game', code: currentRoomCode }));
        }

        function lobbyLeave() {
            if (lobbyWs) lobbyWs.close();
            showMenu('main-menu');
        }

        // --- FIM L√ìGICA LOBBY ---

        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    localStorage.setItem('temp_save_data', JSON.stringify(data));
                    window.location.href = 'game.html?mode=load';
                } catch (err) {
                    alert("Arquivo inv√°lido!");
                }
            };
            reader.readAsText(file);
        }

        function showMenu(menuId) {
            // Esconde todas as telas de menu
            document.querySelectorAll('.menu-screen').forEach(m => m.style.display = 'none');
            
            // Esconde todos os modais (Op√ß√µes, Nickname, etc)
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');

            if (menuId) {
                const target = document.getElementById(menuId);
                if (target) {
                    // Se for um modal, usa flex, sen√£o block
                    target.style.display = target.classList.contains('modal') ? 'flex' : 'block';
                }
                if (menuId === 'multiplayer-menu') checkMultiplayerSave();
            }
        }

        function showSettingsMenu() {
            showMenu('settings-menu-main');
        }

        function deleteSaveDataMain() {
            if (confirm("Tem certeza que deseja excluir o mundo? Esta a√ß√£o √© irrevers√≠vel.")) {
                localStorage.removeItem('osubterraneo_save');
                localStorage.removeItem('playerNickname');
                alert("Mundo exclu√≠do! A p√°gina ser√° recarregada.");
                window.location.reload();
            }
        }

        // --- ANIMA√á√ÉO ELITE DO MENU (SUBTERR√ÇNEO CINEM√ÅTICO) ---
        const bgCanvas = document.getElementById('menu-bg-canvas');
        const bctx = bgCanvas.getContext('2d');
        let particles = [];
        let menuAnts = [];
        let bgStones = [];
        let mouseX = window.innerWidth / 2;
        let mouseY = window.innerHeight / 2;

        function resizeBg() {
            bgCanvas.width = window.innerWidth;
            bgCanvas.height = window.innerHeight;
            generateBgDetails();
        }
        window.addEventListener('resize', resizeBg);
        window.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
        });

        function generateBgDetails() {
            bgStones = [];
            for(let i=0; i<15; i++) {
                bgStones.push({
                    x: Math.random() * bgCanvas.width,
                    y: Math.random() * bgCanvas.height,
                    size: 10 + Math.random() * 40,
                    color: `rgb(${40 + Math.random()*20}, ${30 + Math.random()*15}, ${20})`,
                    depth: 0.5 + Math.random() * 1.5
                });
            }
        }
        generateBgDetails();

        // Inicializar Part√≠culas (Esporos)
        for(let i=0; i<100; i++) {
            particles.push({
                x: Math.random() * bgCanvas.width,
                y: Math.random() * bgCanvas.height,
                size: Math.random() * 2 + 1,
                vx: (Math.random() - 0.5) * 0.3,
                vy: (Math.random() - 0.5) * 0.3,
                depth: Math.random() * 2 + 1
            });
        }

        // Inicializar Formigas de Fundo
        function spawnMenuAnt() {
            if (menuAnts.length < 5) {
                const side = Math.random() > 0.5 ? 1 : -1;
                menuAnts.push({
                    x: side > 0 ? -50 : bgCanvas.width + 50,
                    y: Math.random() * bgCanvas.height,
                    speed: (Math.random() * 1 + 0.5) * side,
                    angle: side > 0 ? 0 : Math.PI,
                    size: 3 + Math.random() * 2,
                    legCycle: 0
                });
            }
        }

        function drawMenuBg() {
            // 1. FUNDO PROFUNDO
            bctx.fillStyle = '#050300';
            bctx.fillRect(0, 0, bgCanvas.width, bgCanvas.height);

            // 2. PEDRAS E RACHADURAS (Paralaxe Profundo)
            bgStones.forEach(s => {
                const sX = s.x + (mouseX - bgCanvas.width/2) * 0.01 * s.depth;
                const sY = s.y + (mouseY - bgCanvas.height/2) * 0.01 * s.depth;
                
                bctx.fillStyle = s.color;
                bctx.beginPath();
                bctx.arc(sX, sY, s.size, 0, Math.PI*2);
                bctx.fill();
                
                bctx.strokeStyle = 'rgba(0,0,0,0.3)';
                bctx.lineWidth = 2;
                bctx.stroke();
            });

            // --- NOVO: FORMIGA SENTINELA ULTRA-REALISTA (MACRO) ---
            const hX = bgCanvas.width * 0.85 + (mouseX - bgCanvas.width/2) * 0.04;
            const hY = bgCanvas.height * 0.75 + (mouseY - bgCanvas.height/2) * 0.04;
            
            // 1. O BURACO (Com profundidade e oclus√£o)
            const holeGrad = bctx.createRadialGradient(hX, hY, 10, hX, hY, 80);
            holeGrad.addColorStop(0, '#000');
            holeGrad.addColorStop(0.8, '#0a0500');
            holeGrad.addColorStop(1, 'rgba(0,0,0,0)');
            bctx.fillStyle = holeGrad;
            bctx.beginPath(); bctx.ellipse(hX, hY, 80, 50, 0, 0, Math.PI*2); bctx.fill();

            // 2. A FORMIGA (Anatomia Macro)
            bctx.save();
            bctx.translate(hX, hY - 5);
            
            const time = Date.now();
            const headColor = '#1a0d00';
            const chitinGrad = bctx.createRadialGradient(-5, -10, 2, 0, 0, 30);
            chitinGrad.addColorStop(0, '#3d1f00'); // Brilho da quitina
            chitinGrad.addColorStop(1, '#050300'); // Sombra profunda

            // MAND√çBULAS DENTEADAS (Serrilhadas)
            const mOpen = Math.abs(Math.sin(time / 600)) * 0.5; // Movimento mais natural
            [-1, 1].forEach(side => {
                bctx.save();
                bctx.fillStyle = '#0a0500';
                bctx.strokeStyle = '#111';
                bctx.lineWidth = 1;
                bctx.translate(side * 8, 15);
                bctx.rotate(side * mOpen);
                
                bctx.beginPath();
                bctx.moveTo(0, 0);
                // Forma curvada da mand√≠bula
                bctx.quadraticCurveTo(side * 25, 5, side * 15, 35);
                // Dentes da mand√≠bula (Serrilha)
                for(let d=0; d<5; d++) {
                    bctx.lineTo(side * (12 - d*2), 30 - d*5);
                    bctx.lineTo(side * (10 - d*2), 28 - d*5);
                }
                bctx.closePath();
                bctx.fill(); bctx.stroke();
                
                // Brilho na ponta da mand√≠bula
                bctx.fillStyle = 'rgba(255,255,255,0.05)';
                bctx.beginPath(); bctx.ellipse(side*10, 20, 5, 10, side*0.5, 0, Math.PI*2); bctx.fill();
                bctx.restore();
            });

            // CABE√áA (C√°psula cef√°lica)
            bctx.fillStyle = chitinGrad;
            bctx.beginPath();
            bctx.moveTo(-25, -5);
            bctx.bezierCurveTo(-30, -30, 30, -30, 25, -5);
            bctx.bezierCurveTo(30, 20, -30, 20, -25, -5);
            bctx.fill();

            // OLHOS COMPOSTOS (Com brilho especular)
            [-1, 1].forEach(side => {
                const eyeX = side * 18;
                const eyeY = -8;
                const eyeGrad = bctx.createRadialGradient(eyeX - side*2, eyeY - 2, 1, eyeX, eyeY, 6);
                eyeGrad.addColorStop(0, '#222');
                eyeGrad.addColorStop(1, '#000');
                bctx.fillStyle = eyeGrad;
                bctx.beginPath(); bctx.arc(eyeX, eyeY, 6, 0, Math.PI*2); bctx.fill();
                
                // Ponto de luz (Reflexo)
                bctx.fillStyle = '#fff';
                bctx.globalAlpha = 0.3;
                bctx.beginPath(); bctx.arc(eyeX - side*2, eyeY - 2, 1.5, 0, Math.PI*2); bctx.fill();
                bctx.globalAlpha = 1.0;
            });

            // CERDAS (Pelinhos sensoriais nas bordas)
            bctx.strokeStyle = 'rgba(255,255,255,0.1)';
            bctx.lineWidth = 0.5;
            for(let p=0; p<20; p++) {
                const ang = (p/20) * Math.PI * 2;
                bctx.beginPath();
                bctx.moveTo(Math.cos(ang)*25, Math.sin(ang)*20);
                bctx.lineTo(Math.cos(ang)*28, Math.sin(ang)*23);
                bctx.stroke();
            }

            // ANTENAS DIN√ÇMICAS (Com dois segmentos)
            [-1, 1].forEach(side => {
                bctx.strokeStyle = '#0a0500';
                bctx.lineWidth = 1.5;
                const aX = side * 10;
                const aY = -15;
                const twitch = Math.sin(time/200 + side) * 5;
                
                bctx.beginPath();
                bctx.moveTo(aX, aY);
                // Escapo
                const ex = aX + side*20;
                const ey = aY - 20 + twitch;
                bctx.lineTo(ex, ey);
                // Fun√≠culo (mais fino)
                bctx.lineWidth = 0.8;
                bctx.lineTo(ex + side*15, ey - 5 + Math.cos(time/300)*10);
                bctx.stroke();
            });

            bctx.restore();

            // 3. PARALAXE DE ESPOROS (Longe)

            // 3. PARALAXE DE ESPOROS (Longe)
            particles.forEach(p => {
                const pX = p.x + (mouseX - bgCanvas.width/2) * 0.02 * p.depth;
                const pY = p.y + (mouseY - bgCanvas.height/2) * 0.02 * p.depth;
                
                const alpha = Math.abs(Math.sin(Date.now() / 2000 + p.x));
                bctx.fillStyle = `rgba(200, 150, 100, ${alpha * 0.2})`;
                bctx.beginPath();
                bctx.arc(pX, pY, p.size, 0, Math.PI * 2);
                bctx.fill();

                p.x += p.vx; p.y += p.vy;
                if(p.x < 0) p.x = bgCanvas.width; if(p.x > bgCanvas.width) p.x = 0;
                if(p.y < 0) p.y = bgCanvas.height; if(p.y > bgCanvas.height) p.y = 0;
            });

            // 3. FORMIGAS ANDANDO (Meio Termo)
            if (Math.random() < 0.01) spawnMenuAnt();
            menuAnts.forEach((ant, index) => {
                ant.x += ant.speed;
                ant.legCycle += 0.2;
                const aX = ant.x + (mouseX - bgCanvas.width/2) * 0.05;
                
                bctx.save();
                bctx.translate(aX, ant.y);
                bctx.rotate(ant.angle);
                bctx.fillStyle = 'rgba(0,0,0,0.6)';
                // Desenho simplificado de formiga silhouette
                bctx.beginPath();
                bctx.ellipse(-ant.size, 0, ant.size, ant.size*0.6, 0, 0, Math.PI*2);
                bctx.ellipse(0, 0, ant.size*0.7, ant.size*0.5, 0, 0, Math.PI*2);
                bctx.ellipse(ant.size, 0, ant.size*0.8, ant.size*0.7, 0, 0, Math.PI*2);
                bctx.fill();
                bctx.restore();

                if (ant.x > bgCanvas.width + 100 || ant.x < -100) menuAnts.splice(index, 1);
            });

            // 4. RA√çZES COM PARALAXE (Perto)
            bctx.strokeStyle = 'rgba(40, 25, 10, 0.5)';
            bctx.lineWidth = 4;
            for(let i=0; i<6; i++) {
                const rX = (i/6) * bgCanvas.width + (mouseX - bgCanvas.width/2) * 0.1;
                const sway = Math.sin(Date.now() / 3000 + i) * 30;
                bctx.beginPath();
                bctx.moveTo(rX, -20);
                bctx.quadraticCurveTo(rX + sway, bgCanvas.height/2, rX, bgCanvas.height + 20);
                bctx.stroke();
            }

            // 5. ILUMINA√á√ÉO DIN√ÇMICA (Segue o Mouse)
            const lightGrad = bctx.createRadialGradient(mouseX, mouseY, 0, mouseX, mouseY, bgCanvas.width/1.5);
            lightGrad.addColorStop(0, 'rgba(210, 105, 30, 0.15)');
            lightGrad.addColorStop(0.5, 'rgba(0,0,0,0)');
            lightGrad.addColorStop(1, 'rgba(0,0,0,0.8)');
            bctx.fillStyle = lightGrad;
            bctx.fillRect(0, 0, bgCanvas.width, bgCanvas.height);

            // 6. VINHETA FIXA
            const vinn = bctx.createRadialGradient(bgCanvas.width/2, bgCanvas.height/2, 0, bgCanvas.width/2, bgCanvas.height/2, bgCanvas.width);
            vinn.addColorStop(0, 'transparent');
            vinn.addColorStop(1, 'rgba(0,0,0,0.7)');
            bctx.fillStyle = vinn;
            bctx.fillRect(0, 0, bgCanvas.width, bgCanvas.height);

            requestAnimationFrame(drawMenuBg);
        }
        drawMenuBg();
    </script>    <!-- Nickname Modal -->
    <div id="nickname-modal" class="modal">
        <div class="modal-content">
            <h2>Bem-vindo!</h2>
            <p>Por favor, digite um apelido para o seu jogador:</p>
            <input type="text" id="player-nickname-input" placeholder="Seu apelido" maxlength="15">
            <button onclick="savePlayerNickname()">Confirmar</button>
        </div>
    </div>
    </body>
    </html>